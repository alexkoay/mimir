type: data/query
name: WIP Rounding
auto: true
cmd: |
    WITH wip AS (
        SELECT p.company, p.wipno,
            (CASE left(p.part, 1)
                WHEN 'B' THEN 'B'
                WHEN 'C' THEN 'C'
                WHEN 'M' THEN 'M'
                WHEN 'E' THEN 'E'
                ELSE 'Z'
            END) fran,
            p.order * p.cost * p.contribution / 100 as cost
        FROM wip_parts p
        WHERE ordstat = 'X' AND invstat in ('H', 'I')
    ),
    wipg AS (
        SELECT
            (CASE company
                WHEN 'A1' THEN '0040'
                WHEN 'A2' THEN '0140'
                WHEN 'A3' THEN '0240'
                WHEN 'A4' THEN '0340'
                WHEN 'A5' THEN '0440'
                WHEN 'AA' THEN '0043'
                WHEN 'AD' THEN '0343'
                WHEN 'AK' THEN '0049'
                ELSE '0000'
            END) as cc,
            company, wipno,
            (CASE fran
                WHEN 'B' THEN 14000001
                WHEN 'M' THEN 14010001
                WHEN 'C' THEN 14030001
                WHEN 'E' THEN 14040001
                ELSE 14080001
            END) expense,
            fran, sum(round(cost::decimal, 2)) AS cost
        FROM wip group by company, wipno, fran
    ),
    acct AS (
        SELECT cost AS cc,
            (CASE cost
                WHEN '0040' THEN 'A1'
                WHEN '0140' THEN 'A2'
                WHEN '0240' THEN 'A3'
                WHEN '0340' THEN 'A4'
                WHEN '0440' THEN 'A5'
                WHEN '0043' THEN 'AA'
                WHEN '0343' THEN 'AD'
                WHEN '0049' THEN 'AK'
                ELSE 'A0'
            END) company,
            suffix, expense,
            (CASE expense
                WHEN 14000001 THEN 'B'
                WHEN 14010001 THEN 'M'
                WHEN 14030001 THEN 'C'
                WHEN 14040001 THEN 'E'
                WHEN 14040002 THEN 'E'
                WHEN 14040003 THEN 'E'
                WHEN 14040004 THEN 'E'
                ELSE 'Z'
            END) fran,
            sum(round(value::decimal, 2)) AS value
        FROM nl WHERE expense / 1000000 = 14 GROUP BY cost, expense, suffix
    ),
    error AS (
        SELECT coalesce(w.company, a.company) company,
            coalesce(w.wipno::text, a.suffix) wip,
            coalesce(w.fran, a.fran)::character fran,
            coalesce(w.cc, a.cc) AS cc,
            coalesce(w.expense, a.expense) expense,
            w.cost, a.value
        FROM wipg w FULL OUTER JOIN acct a
            ON a.company = w.company AND a.suffix = w.wipno::text AND a.fran = w.fran
        WHERE (w.cost != 0 OR a.value != 0)
            AND (w.cost != a.value OR w.cost IS NULL OR a.value IS NULL)
    )
    select company "Co", wip "WIP", fran "Fr", cc "C.C.", expense "Expense", cost "WIP Value", value "NL Value"  from error e
#   parts as (select *, round(cost::decimal, 2) round2 from wip_parts p where exists (select 1 from error e where e.company = p.company and e.wip = p.wipno::text) and p.ordstat != 'D'),
#   invoiced as (select * from wip_parts p where exists (select 1 from error e where e.company = p.company and e.wip = p.wipno::text) and p.ordstat != 'D')
