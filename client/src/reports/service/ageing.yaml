type: data/query
name: WIP Ageing
auto: true
cmd: |
    WITH trans AS (
        SELECT
            (CASE cost
                WHEN '0040' THEN 'A1'
                WHEN '0140' THEN 'A2'    WHEN '0150' THEN 'A2'
                WHEN '0240' THEN 'A3'    WHEN '0250' THEN 'A3'
                WHEN '0340' THEN 'A4'    WHEN '0350' THEN 'A4'
                WHEN '0440' THEN 'A5'    WHEN '0450' THEN 'A5'
                WHEN '0043' THEN 'AA'    WHEN '0053' THEN 'AA'
                WHEN '0343' THEN 'AD'    WHEN '0353' THEN 'AD'
                WHEN '0049' THEN 'AK'    WHEN '0060' THEN 'AK'
                ELSE (CASE
                    WHEN company = 'AY' THEN 'AY'
                    WHEN cost = '0050' THEN 'A1'
                    ELSE 'A0'
                END)
            END) company,
            (CASE WHEN suffix ~ '^[NU]\\d+$' THEN customer ELSE suffix END) as suffix,
            cost, expense, posting, account, narrative, value
        FROM nl_trans
        WHERE (expense = 13100002 OR expense / 1000000 = 14) AND
            posting <= ${{key:'cutoff', name: 'Cut-off Date', value: today()}}::date
    ),
    data AS (
        SELECT n.company, n.suffix,
            w.regno, COALESCE(w.account, n.account) as account, COALESCE(w.customer, n.narrative) as customer, w.first_in, w.check_in, o.name,
            n.cost, n.expense, n.posting, n.value,
            LEAST(w.first_in, w.check_in, n.posting) agedate
        FROM trans n
            LEFT OUTER JOIN wip_header w ON w.company = n.company AND n.suffix = w.wipstr
            LEFT OUTER JOIN pos_opers o ON o.company = n.company AND (CASE w.opowner WHEN '' THEN w.opcreate ELSE w.opowner END) = o.operator
    ),
    grouped AS (
        SELECT company as "Company", suffix as "WIP", MAX(regno) "Reg. No", MAX(account) "Account", MAX(customer) "Customer", MIN(first_in) "First Check In", MAX(check_in) "Checked In", MAX(name) "Name",
        MIN(agedate) as "Age Date", now()::date - MIN(agedate) as "Days",
        ROUND(SUM(value)::decimal, 2) as "Total",
        ROUND(SUM(value) FILTER (WHERE expense / 10000 = 1400)::decimal, 2) as "BMW Parts",
        ROUND(SUM(value) FILTER (WHERE expense / 10000 = 1401)::decimal, 2) as "MINI Parts",
        ROUND(SUM(value) FILTER (WHERE expense / 10000 = 1403)::decimal, 2) as "MR Parts",
        ROUND(SUM(value) FILTER (WHERE expense / 10000 = 1404)::decimal, 2) as "BMW-I Parts",
        ROUND(SUM(value) FILTER (WHERE expense / 10000 = 1408)::decimal, 2) as "Other Parts",
        ROUND(SUM(value) FILTER (WHERE expense = 13100002)::decimal, 2) as "Sublet"
        FROM data
        GROUP BY "Company", "WIP"
    )
    SELECT *,
        (CASE WHEN "Days" <= 30 THEN "Total" ELSE NULL END) "< 30 days",
        (CASE WHEN 30 < "Days" AND "Days" <= 60 THEN "Total" ELSE NULL END) "31 to 60 days",
        (CASE WHEN 60 < "Days" AND "Days" <= 90 THEN "Total" ELSE NULL END) "61 to 90 days",
        (CASE WHEN 90 < "Days" AND "Days" <= 120 THEN "Total" ELSE NULL END) "91 to 120 days",
        (CASE WHEN 120 < "Days" AND "Days" <= 150 THEN "Total" ELSE NULL END) "121 to 150 days",
        (CASE WHEN 150 < "Days" AND "Days" <= 180 THEN "Total" ELSE NULL END) "151 to 180 days",
        (CASE WHEN 180 < "Days" AND "Days" <= 270 THEN "Total" ELSE NULL END) "181 to 270 days",
        (CASE WHEN 270 < "Days" AND "Days" <= 365 THEN "Total" ELSE NULL END) "271 to 365 days",
        (CASE WHEN 365 < "Days" THEN "Total" ELSE NULL END) "Over a year" FROM grouped
        WHERE "Total" != 0
    ORDER BY "Company", "Days" DESC, "WIP"